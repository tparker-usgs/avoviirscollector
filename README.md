avoviirscollector
=================
[![Build Status](https://travis-ci.org/tparker-usgs/avoviirscollector.svg?branch=master)](https://travis-ci.org/tparker-usgs/avoviirscollector)
[![Code Climate](https://codeclimate.com/github/tparker-usgs/avoviirscollector/badges/gpa.svg)](https://codeclimate.com/github/tparker-usgs/avoviirscollector)

Docker container to collect viirs data at AVO

**I'm still under development. Some of what you see below is outdated, while other parts may be aspirational. Talk to Tom 
before doing anything that matters.**


Overview
--------
I gather VIIRS data files and present an event stream of products to produce. 

I peridically run scripts to retrieve files from remote sources and publish collections using the 
[posttroll](https://github.com/pytroll/posttroll) messaging system.

Daemons:
  * supervisord - launches all other deamons and keeps them running
  * supercronic - a cron daemon which Launches periodic tasks
  * nameserver - keeps track of active publishers on the internal messaging system and tells listeners where to find 
                 active publishers.
  * trollstalker - watches local directories for new files and publishes files as they're recieved
  * segment_gatherer - listens to trollstalker and assembles files into a complete granule
  * msg_broker - collects messages from segment_gatherer and provides tasks to 
                 [viirsprocessors](https://github.com/tparker-usgs/avoviirsprocessor)
  
Cron taks:
  * mirror_gina - searches GINA for recent images and retrieves any found
  * cleanup - remove old images

Filesystem
----------

I'll do all of my work under /viirs. When you run the docker image, mount a volume there.

Environment Variables
---------------------
**general**
  * VIIRS_RETENTION - if this is defined, files in /viirs will be cleaned up after this many days.


**mirror_gina**
  * NUM_GINA_CONNECTIONS - files will be retrieved in segments using this many connections in parallel
  * GINA_BACKFILL_DAYS - data will be made complete over this many days
  * VIIRS_FACILITY - use data received at UAF or Gilmore Creek?


**logs** I will email errors generated by mirror_gina and msg_broker if these are provided.
  * MAILHOST - who can forward mail for me?
  * LOG_SENDER - From: address
  * LOG_RECIPIENT - To: address


Logs
----
All logs are written to viirs/log/avoviirscollector. Daemons will have their own logs, but mirror_gina will show up in 
the supercronic logs. Unfortunatle, supervisord creates the logs with very restrictive perms. There's an open
[issue](https://github.com/Supervisor/supervisor/issues/123) on it.


supervisord
-----------
Launch deamons and keep them running. Additional info on supervisord is available at <http://supervisord.org/>. Check 
the supervisord log to see how stable the daemons are. When everything is going well this is a short boring log.


supercronic
-----------
Launch mirror_gina and cleanup. Additional info on supercronic is available at <https://github.com/aptible/supercronic>.
The supercronic logs will capture anything interesting from mirror_gina.


nameserver
----------
nameserver is part of the PyTroll posttroll project. Additional info on posttrol is available at
<https://github.com/pytroll/posttroll>. nameserver keeps track of topics learned from messages broadcasted 
by publishers and responds to queries from listeners looking for a topic. It has no configuration file and rarely causes
trouble. This is how msg_broker learns about running segment_gatherers.


trollstalker
------------
trollstalker is part of the PyTroll pytroll-collectors project. Additional info on pytroll-collectors is available at
<https://github.com/pytroll/pytroll-collectors>. 

trollstalker uses inotify to watch for new files and publishes messages 
to start processing. This means things will only run on Linux. Additionally, it's important to think about inotify's 
scope. A NFS filesystem with a remote file writer won't work, as inotify wouldn't see the I/O.


segment_gatherer
----------------
segment_gatherer is part of the PyTroll pytroll-collectors project. Additional info on pytroll-collectors is available
at <https://github.com/pytroll/pytroll-collectors>. 

segment_gatherer listens to messages published by trollstalker and publishes a message once sufficient data is available 
to create a product. One instance of segment_gatherer runs for each product and sends messasges tagged with the product
to be creted. These messages become the tasks distributed by msg_broker.


mirror_gina
-----------
Searches GINA NRT with parameters provided in the environemnt and retrieves any new files found. mirror_gina doesn't
write its own logs, look for output in the supercronic logs.


cleanup
-------
Nightly I'll cleanup files in /viirs, removing any that are older than $VIIRS_RETENTION days. All
files, even ones you might not think of.


docker-compose
--------------
Here is an example service stanza for use with docker-compose.

    viirscollector:
      image: "tparkerusgs/avoviirscollector:release-2.0.2"
      user: "2001"
      environment:
        - VIIRS_RETENTION=7
        - NUM_GINA_CONNECTIONS=4
        - GINA_BACKFILL_DAYS=2
        - VIIRS_FACILITY=gilmore
        - PYTHONUNBUFFERED=1
        - MAILHOST=smtp.address.com
        - LOG_SENDER=worker@address.com
        - LOG_RECIPIENT=email@address.com
      restart: always
      logging:
        driver: json-file
        options:
          max-size: 10m
      volumes:
        - type: volume
          source: viirs
          target: /viirs
          volume:
            nocopy: true
